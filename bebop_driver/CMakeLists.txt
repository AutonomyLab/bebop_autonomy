cmake_minimum_required(VERSION 2.8.3)
project(bebop_driver)

## Enable hardware (Bebop In The Loop Tests)
option(RUN_HARDWARE_TESTS "Enable hardware (Bebop In The Loop Tests" OFF)

find_package(catkin REQUIRED COMPONENTS
  parrot_arsdk
  bebop_msgs
  nodelet
  camera_info_manager
  image_transport
  nav_msgs
  roscpp
  std_msgs
  tf2
  tf2_ros
  tf2_geometry_msgs
  dynamic_reconfigure
  roslint
)

message(STATUS "Catkin INCLUE_DIR: ${catkin_INCLUDE_DIRS}")
message(STATUS "Catkin LIBS: ${catkin_LIBRARIES}")
message(STATUS "ARSDK3 INCLUDE_DIR: ${ARSDK_INCLUDE_DIR}")
message(STATUS "ARSDK3 LIB_DIR: ${ARSDK_LIB_DIR}")
message(STATUS "ARSDK3 LIBS: ${ARSDK_LIBS}")

generate_dynamic_reconfigure_options(
  cfg/autogenerated/BebopArdrone3.cfg
)

# Video decoding dependencies (libbebop)
find_package(PkgConfig REQUIRED)
pkg_check_modules(AVCODEC REQUIRED libavcodec)
pkg_check_modules(AVFORMAT REQUIRED libavformat)
pkg_check_modules(SWSCALE REQUIRED libswscale)

# TODO: Should we state all catkin depends?
catkin_package(
   INCLUDE_DIRS include
   LIBRARIES libbebop bebop_driver_nodelet
   CATKIN_DEPENDS parrot_arsdk bebop_msgs bebop_description roscpp nodelet camera_info_manager image_transport nav_msgs std_msgs tf2 tf2_ros tf2_geometry_msgs dynamic_reconfigure
   DEPENDS system_lib libavcodec libavformat libswscale
)

# roslint
set(ROSLINT_CPP_OPTS "--filter=-build/include")
roslint_cpp(
  src/bebop.cpp
  src/bebop_driver_node.cpp
  src/bebop_driver_nodelet.cpp
  src/bebop_video_decoder.cpp
  include/bebop_driver/bebop.h
  include/bebop_driver/bebop_driver_nodelet.h
  include/bebop_driver/bebop_video_decoder.h
)

###########
## Build ##
###########

include_directories(
  ${catkin_INCLUDE_DIRS}
  ${ARSDK_INCLUDE_DIR}
  include
  ${AVCODEC_INCLUDE_DIRS}
  ${AVFORMAT_INCLUDE_DIRS}
  ${SWSCALE_INCLUDE_DIRS}
)

link_directories(${ARDRONESDK3_PATH}/lib
  ${ARSDK_LIB_DIR}
  ${AVCODEC_LIBRARY_DIRS}
  ${AVFORMAT_LIBRARY_DIRS}
  ${SWSCALE_LIBRARY_DIRS}
)

add_library(bebop src/bebop.cpp src/bebop_video_decoder.cpp)
target_link_libraries(bebop
  ${catkin_LIBRARIES}
  ${ARSDK_LIBS}
  ${AVCODEC_LIBRARIES}
  ${AVFORMAT_LIBRARIES}
  ${SWSCALE_LIBRARIES}
)

add_dependencies(bebop ${PROJECT_NAME}_gencfg)

add_library(bebop_driver_nodelet src/bebop_driver_nodelet.cpp)
target_link_libraries(bebop_driver_nodelet
  ${catkin_LIBRARIES}
  bebop
)

add_executable(bebop_driver_node src/bebop_driver_node.cpp)
target_link_libraries(bebop_driver_node
  ${catkin_LIBRARIES}
  bebop
)

#############
## Install ##
#############

# all install targets should use catkin DESTINATION variables
# See http://ros.org/doc/api/catkin/html/adv_user_guide/variables.html

## Mark executable scripts (Python etc.) for installation
## in contrast to setup.py, you can choose the destination
# install(PROGRAMS
#   scripts/my_python_script
#   DESTINATION ${CATKIN_PACKAGE_BIN_DESTINATION}
# )

## Mark executables and/or libraries for installation
# install(TARGETS bebop_autonomy bebop_autonomy_node
#   ARCHIVE DESTINATION ${CATKIN_PACKAGE_LIB_DESTINATION}
#   LIBRARY DESTINATION ${CATKIN_PACKAGE_LIB_DESTINATION}
#   RUNTIME DESTINATION ${CATKIN_PACKAGE_BIN_DESTINATION}
# )

## Mark cpp header files for installation
# install(DIRECTORY include/${PROJECT_NAME}/
#   DESTINATION ${CATKIN_PACKAGE_INCLUDE_DESTINATION}
#   FILES_MATCHING PATTERN "*.h"
#   PATTERN ".svn" EXCLUDE
# )

## Mark other files for installation (e.g. launch and bag files, etc.)
# install(FILES
#   # myfile1
#   # myfile2
#   DESTINATION ${CATKIN_PACKAGE_SHARE_DESTINATION}
# )

#############
## Testing ##
#############

if(CATKIN_ENABLE_TESTING AND RUN_HARDWARE_TESTS)
  find_package(rostest REQUIRED)
  add_rostest_gtest(bebop_itl_test test/bebop_itl_test.test test/bebop_itl_test.cpp)
  target_link_libraries(bebop_itl_test ${catkin_LIBRARIES})
endif()
